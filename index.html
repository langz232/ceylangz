<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Capture Foto ke Telegram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: white;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #status {
            margin-top: 50px;
            font-size: 18px;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            min-height: 60px;
        }
        #config-form {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            border-radius: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .success { background: #e6f7e6; }
        .error { background: #ffebee; color: #d32f2f; }
        .loading { background: #fff3e0; }
    </style>
</head>
<body>
    <h1>Auto Capture Foto ke Telegram</h1>
    
    <div id="config-form">
        <h3>Konfigurasi Telegram</h3>
        <label for="bot-token">Token Bot Telegram:</label>
        <input type="text" id="bot-token" placeholder="7548364986:AAGhIDQas3V9_Cz1Td7XXsLUKn7vYqjgzOY">
        
        <label for="chat-id">Chat ID:</label>
        <input type="text" id="chat-id" placeholder="7041008009">
        
        <button id="start-btn">Mulai Proses</button>
        <p><small>Dapatkan Token Bot dari @BotFather dan Chat ID dari @userinfobot</small></p>
    </div>
    
    <div id="status" class="loading">Silakan isi konfigurasi Telegram</div>

    <script>
        // Elemen UI
        const statusEl = document.getElementById('status');
        const configForm = document.getElementById('config-form');
        const botTokenInput = document.getElementById('bot-token');
        const chatIdInput = document.getElementById('chat-id');
        const startBtn = document.getElementById('start-btn');
        
        // Optimasi waktu fokus berdasarkan perangkat
        function getFocusDelay() {
            // Delay lebih panjang untuk perangkat mobile
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                return 1500; // 1.5 detik untuk mobile
            }
            return 800; // 0.8 detik untuk desktop
        }
        
        // Fungsi utama
        async function initialize() {
            // Validasi input
            const botToken = botTokenInput.value.trim();
            const chatId = chatIdInput.value.trim();
            
            if (!botToken || !botToken.startsWith('bot') || !chatId) {
                showError("Format tidak valid. Token harus dimulai dengan 'bot' dan Chat ID harus angka");
                return;
            }
            
            try {
                // 1. Cek koneksi internet
                if (!navigator.onLine) {
                    throw new Error("Tidak ada koneksi internet");
                }
                
                // 2. Sembunyikan form config
                configForm.style.display = 'none';
                showStatus("Mengakses kamera...", 'loading');
                
                // 3. Ambil foto dengan optimasi fokus
                const focusDelay = getFocusDelay();
                showStatus(`Menyiapkan kamera (${focusDelay/1000} detik)...`, 'loading');
                const photoDataUrl = await capturePhoto(focusDelay);
                
                // 4. Kirim ke Telegram
                showStatus("Mengirim foto ke Telegram...", 'loading');
                await sendToTelegram(botToken, chatId, photoDataUrl);
                
                showStatus("✅ Foto berhasil dikirim ke Telegram!", 'success');
                
            } catch (error) {
                showError(error.message);
                configForm.style.display = 'block';
            }
        }
        
        // Fungsi ambil foto dengan optimasi fokus
        async function capturePhoto(focusDelay) {
            let stream;
            try {
                // Cek dukungan kamera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Browser tidak mendukung akses kamera");
                }
                
                // Dapatkan stream kamera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                
                // Tunggu kamera siap dengan timeout
                await new Promise((resolve, reject) => {
                    const timer = setTimeout(() => {
                        reject(new Error("Kamera membutuhkan waktu terlalu lama untuk memulai"));
                    }, 5000); // Timeout 5 detik
                    
                    video.onloadedmetadata = () => {
                        clearTimeout(timer);
                        setTimeout(resolve, focusDelay); // Biarkan kamera fokus
                    };
                    
                    video.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error("Gagal memuat kamera"));
                    };
                });
                
                // Ambil foto
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                return canvas.toDataURL('image/jpeg', 0.8);
                
            } catch (error) {
                throw new Error("Gagal mengambil foto: " + error.message);
            } finally {
                // Pastikan stream dihentikan
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
        }
        
        // Fungsi kirim ke Telegram
        async function sendToTelegram(botToken, chatId, photoDataUrl) {
            try {
                // Konversi data URL ke blob
                const blob = await (await fetch(photoDataUrl)).blob();
                const formData = new FormData();
                
                formData.append('chat_id', chatId);
                formData.append('photo', blob, 'capture.jpg');
                formData.append('caption', `Foto otomatis\nWaktu: ${new Date().toLocaleString()}`);
                
                // Test koneksi ke API Telegram
                const testResponse = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);
                if (!testResponse.ok) {
                    throw new Error("Token Bot tidak valid atau tidak ada koneksi ke Telegram");
                }
                
                // Kirim foto
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error(result.description || "Gagal mengirim ke Telegram");
                }
                
                return result;
                
            } catch (error) {
                throw new Error("Gagal mengirim ke Telegram: " + error.message);
            }
        }
        
        // Fungsi tampilkan status
        function showStatus(message, statusClass = '') {
            statusEl.textContent = message;
            statusEl.className = statusClass;
        }
        
        // Fungsi tampilkan error
        function showError(message) {
            statusEl.textContent = "❌ Error: " + message;
            statusEl.className = 'error';
        }
        
        // Event listener
        startBtn.addEventListener('click', initialize);
        
        // Cek konfigurasi tersimpan
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('telegram_bot_token');
            const savedChatId = localStorage.getItem('telegram_chat_id');
            
            if (savedToken && savedChatId) {
                botTokenInput.value = savedToken;
                chatIdInput.value = savedChatId;
            }
        });
    </script>
</body>
</html>
